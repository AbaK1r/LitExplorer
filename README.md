### **AI协同开发文档：LitExplorer项目**

#### **1. 项目概述与核心目标**

**项目名称：** LitExplorer

**核心目标：** 开发一个Rust命令行TUI工具，用于高效管理、可视化对比和操作基于PyTorch Lightning和Hydra产生的交叉验证实验日志。

**解决痛点：** 用户手动管理大量`lightning_logs/version_*`目录效率低下，无法快速识别实验组、对比参数差异以及批量操作模型测试。

#### **2. 技术栈与关键依赖库 (Crates)**

*   **TUI渲染:** `ratatui` (当前社区维护的主流TUI库) + `crossterm` (处理终端事件与渲染，跨平台支持好)

*   **配置解析:** `toml` (解析项目配置) + `serde` (序列化/反序列化框架)

*   **数据解析:** `serde_yaml` (解析`hparams.yaml`文件)

*   **命令行解析:** `clap` (解析启动命令行参数)

*   **文件遍历:** `walkdir` (高效递归遍历日志目录)

*   **外部命令调用:** `std::process::Command` (调用外部`test.py`脚本)

*   **错误处理:** `anyhow` (提供易于使用的错误处理上下文) 或 `thiserror` (定义详细的错误类型)

*   **数据建模:** 标准库`std::collections::HashMap`等。

#### **3. 详细功能需求**

1.  **配置驱动:** 通过根目录的`lightning_explorer.toml`文件配置工具行为。

2.  **日志扫描与解析:** 扫描配置的`log_dir`，解析每个`version_*`目录下的`hparams.yaml`文件。

3.  **实验智能分组:**

*   根据配置的`ignored_parameters`列表忽略无关参数（如`fold`, `devices`）。

*   根据`tolerance`规则（浮点容差、字符串大小写）比较参数值。

*   将参数完全相同的version归为同一实验组（高亮为绿色）。

*   将参数差异数在`similarity_threshold`范围内的version归为相似实验（高亮为黄色）。

4.  **交互式TUI:**

*   **布局:** 主列表显示version及其关键参数，状态栏显示操作提示，详情面板显示参数差异。

*   **导航:** 上下键浏览列表，左右键切换实验组焦点。

*   **选择:** 空格键选择/取消选择当前version，用于批量操作。

*   **高亮:** 自动高亮相同组（绿色）和相似实验（黄色），并标明差异参数。

*   **过滤:** 按`/`键输入文本，实时过滤列表。

*   **执行:** 按回车键确认，调用外部测试脚本。

5.  **外部脚本集成:** 将用户选择的version列表作为参数，调用`test.py`脚本。支持交互式输入`--filter`和`--sort_key`参数。

#### **4. 核心数据模型 (Rust Structs)**

已在文件中定义

#### **5. 开发路线图 (分阶段实施)**

**阶段一：项目初始化与核心数据建模 (MVP Core)**

*   **任务 1.1:** 创建项目 (`cargo new`)，配置`Cargo.toml`依赖。 已完成

*   **任务 1.2:** 定义核心数据结构 (`Config`, `ParameterValue`, `VersionData`, `ExperimentGroup`, `AppState`)。 已完成

*   **任务 1.3:** 实现配置加载逻辑，从`lightning_explorer.toml`反序列化到`Config`结构体。 已完成

*   **任务 1.4:** 实现使用`walkdir`遍历日志目录，收集所有`hparams.yaml`文件路径。 已完成

*   **任务 1.5:** 实现使用`serde_yaml`将YAML文件解析到`HashMap<String, ParameterValue>`。 已完成

*   **任务 1.6:** **核心算法:** 实现实验分组逻辑，根据`Config`中的规则将`Vec<VersionData>`分组为`Vec<ExperimentGroup>`。 已完成

*   **验收标准:** 能运行CLI程序，打印分组结果（如`Found 5 experiment groups. Group 1 has versions: [0, 1, 2, 3, 4]`）。 已完成

**阶段二：TUI集成与基本交互 (MVP UI)**

*   **任务 2.1:** 引入`ratatui`和`crossterm`依赖，搭建基本TUI事件循环框架。

*   **任务 2.2:** 实现基本的TUI布局（列表、状态栏）。

*   **任务 2.3:** 将`AppState`中的版本列表渲染到TUI的`List` widget中。

*   **任务 2.4:** 实现键盘事件捕获，完成上下键浏览列表功能。

*   **验收标准:** 启动程序后，显示可交互的TUI界面，能用键盘浏览版本列表。

**阶段三：高级功能实现 (Complete Feature)**

*   **任务 3.1:** 实现实验组高亮逻辑（绿色高亮相同组）。

*   **任务 3.2:** 实现相似实验查找与高亮逻辑（黄色高亮，状态栏显示差异）。

*   **任务 3.3:** 实现多选功能（空格键）和状态管理。

*   **任务 3.4:** 实现调用`test.py`的逻辑 (`std::process::Command`)。

*   **任务 3.5:** 实现过滤（`/`键）和帮助（`h`键）功能。

*   **验收标准:** TUI所有交互功能正常工作，能正确高亮、选择并调用外部脚本。

**阶段四：打磨与发布 (Polish)**

*   **任务 4.1:** 全面的错误处理（使用`anyhow?`或`thiserror`定义错误类型）。

*   **任务 4.2:** 性能优化（如分组算法、缓存）。

*   **任务 4.3:** 编写文档 (`README.md`)。

*   **任务 4.4:** 使用`cargo build --release`生成最终二进制文件。

#### **6. 交互式协作指南**

*   **AI角色:** 作为技术联合创始人与Rust导师。

*   **协作模式:** 用户按照路线图推进，在具体任务中遇到问题时，向AI提供**任务编号**、**相关代码片段**和**具体问题描述**。

*   **AI职责:**

1.  提供针对特定任务的代码示例、解决方案和最佳实践。

2.  解释Rust概念（所有权、生命周期、Traits、错误处理）。

3.  推荐Crates的用法和API。

4.  协助调试和优化代码。